"use strict";(globalThis.webpackChunk_flippingbook_publication=globalThis.webpackChunk_flippingbook_publication||[]).push([[28],{9070:(e,t,n)=>{n.r(t),n.d(t,{Search:()=>u,SearchResult:()=>l});var r=n(1071),i=n(320),s=n(5475),o=n(3624),a=n(8531);const c="search/";function h(e){this.counts=0;for(let t=0;t<e.searchIndex.length;t++)this.counts+=e.searchIndex[t].length;this.progress=null}function l(e){let{pageId:t,text:n,relevance:r,count:i,positions:s,coincidenceData:o,normalizedToVirginMap:a,previewCount:c}=e;this.pageId=t,this.text=n,this.relevance=r,this.count=i,this.previewCount=c,this.positions=s.slice(0),this.normalizedToVirginMap=a,this.coincidenceData=JSON.parse(JSON.stringify(o||{}))}function u(e,t){this.searchState=e,this.store=t,this.status=new h(e)}function g(e){let{index:t,regExp:n,normalizedQuery:r,normalizedText:i}=e;if(n){const e=n.exec(i);return e?e.index+e[0].indexOf(r):-1}return i.indexOf(r,t+1)}function p(e){if(/\p{sc=Han}/gu.test(e))return null;const t=/[\[\]\\^$.|?*+()]+?/g,n=e.replace(t,(e=>"\\"+e)),r=/[\p{P}\p{M}\p{S}\p{Zl}\p{Zp}]*/gu,i=s.Z.getHtmlExceptions(),o=/(^|\s)/.source+"("+r.source+i.source+")",a="("+r.source+i.source+")"+/(\s|$)/.source;return new RegExp(`(${o})${n}(${a})`,"u")}function d(e,t){const n=e.split(" "),r=[];for(let i=0;i<n.length;i++)n[i].length>=t&&r.push(n[i]);return r}function y(e,t){let n;for(let r=0;r<e.length&&!(e[r]>t);r++)n=e[r];return n}h.prototype.to=function(){return null===this.progress?null:this.progress===this.counts?"complete":{progress:this.progress,of:this.counts}},h.prototype.from=function(e){(0,i.HD)(e)||(this.progress=null)},l.prototype.addPositions=function(e){this.positions=this.positions.concat(e)},u.prototype.getMinimumQueryLength=function(){return this.searchState.searchCharactersLimit},u.prototype.isQueryValid=function(){const e=this.store.getters["search/trimmedNormalizedQuery"];return!(!this.searchState.query||!e)&&e.length>=this.getMinimumQueryLength()},u.prototype.interrupt=function(){(0,i.o8)(this.searchTimer)||(clearTimeout(this.searchTimer),delete this.searchTimer),this.store.commit(c+r.If)},u.prototype.search=function(){if(this.interrupt(),!this.isQueryValid())return this.status.progress=null,void this.store.commit(c+r.Kk,this.status.to());this.status.progress=0,this.store.commit(c+r.Kk,this.status.to());const e=this;let t=0;const n=this._buildSearchObject();let i=[];function s(t,r){for(let s=0;s<t.length;s++){if(!e.searchTimer||e.searchTimer!==r)return;const o=e._processPageIndex(n,t[s]);o&&i.push(o)}e.status.progress+=t.length}this.searchTimer=setTimeout((function o(){e.searchState.query===n.noNormalizedQuery&&(e.searchTimer&&t<e.searchState.searchIndex.length?(s(e.searchState.searchIndex[t],e.searchTimer),t++,e.searchTimer=setTimeout(o,e.searchState.searchInterval)):(e.store.state.pager.singleMode?i=e._divideWidePages(i,e.searchState.searchIndex):e.store.state.pager.spreadMode&&(i=e._joinBySpread(i)),0===i.length&&e.store.commit(c+r.n_,{resultIndex:null}),e.store.commit(c+r.po,i),e.store.commit(c+r.Kk,e.status.to())))}),e.searchState.searchInterval)},u.prototype._divideWidePages=function(e,t){const n=[];for(let r=0;r<e.length;r++){const i=e[r];if(!this.store.getters["pages/pageProp"](i.pageId.toString(),"wide")){n.push(i);continue}i.isWide=!0;const s=[].concat.apply([],t).find((e=>e["@ID"]===i.pageId));if(!s){n.push(i);continue}const o=this.store.state.book.rightToLeft,a=s[o?"#half2":"#half1"],c=s[o?"#half1":"#half2"];if(!a||!c){n.push(i);continue}const h=[],l=[];i.positions.forEach((e=>{const t=i.normalizedToVirginMap[e.startPos],n=y(a,t),r=y(c,t);(n||0===n)&&(r||0===r)&&r>n||!n&&0!==n?l.push(e):h.push(e)})),h.length&&n.push(this._getHalfItem(i,h,!1)),l.length&&n.push(this._getHalfItem(i,l,!0))}return n},u.prototype._joinBySpread=function(e){const t=[];for(let n=0;n<e.length;n++){const r=e[n],i=this.store.getters["pages/pageIndexById"](r.pageId.toString()),s=i%2==0?i-1:i+1,o=this.store.getters["pages/pageIdByIndex"](s),a=o&&e.findIndex((e=>e.pageId.toString()===o));if(!o||-1===a){t.push(r);continue}const c=e.splice(a,1)[0];t.push(i>s?[c,r]:[r,c])}return t},u.prototype._getHalfItem=function(e,t,n){const r=e.coincidenceData,i=e.normalizedToVirginMap;delete e.coincidenceData,delete e.normalizedToVirginMap;let s=JSON.parse(JSON.stringify(e));e.coincidenceData=r,e.normalizedToVirginMap=i,s.positions=t;const o=s.positions.filter((e=>e.isFullCoinidence)),{queryArray:a,queryArrayLength:c,virginContent:h,normalizedContent:l}=r;if(o.length>0)return{...s,...this._getPreviewTextData(h,l,t[0].startPos,a),count:t.length===o.length?t.length:t.length-o.length*c,widePageSecondHalf:n,isDivided:!0};const u=this._buildIndexes(a,c,l).map((e=>e.filter((e=>s.positions.some((t=>t.startPos===e)))))).filter((e=>e.length>0));return s={...s,...this._getRelevanceForParticiallyCoincidence({indexes:u,virginContent:h,normalizedContent:l,queryArray:a,queryArrayLength:c}),widePageSecondHalf:n,isDivided:!0},delete s.coincidenceData,s},u.prototype._buildSearchObject=function(){const e=this.store.getters["search/trimmedNormalizedQuery"],t=this.store.getters["search/normalizedQuery"],n=this.searchState.query,r=t!==e,i=d(t,this.searchState.searchCharactersLimit);return{normalizedQuery:t,trimmedNormalizedQuery:e,noNormalizedQuery:n,trimChangedQuery:r,queryArray:i,queryArrayLength:i.length}},u.prototype._processPageIndex=function(e,t){if(!t)return;const n=t["#text"];if(null===n)return;let r;const i=t["@ID"],o=s.Z.normalize(n,!0);return r=this.searchState.exactMatch?this._searchFullCoincidence({normalizedQuery:e.normalizedQuery,virginContent:n,normalizedContent:o,pageId:i,queryArray:e.queryArray,queryArrayLength:e.queryArray.length}):this._searchPartiallyCoincidence({virginContent:n,normalizedContent:o,pageId:i,queryArray:e.queryArray,queryArrayLength:e.queryArrayLength}),r&&(r.pageIndex=this.store.getters["pages/pageIndexById"](i)),r},u.prototype._getRelevanceForParticiallyCoincidence=function(e){let{indexes:t,virginContent:n,normalizedContent:r,queryArray:i,queryArrayLength:s}=e,o=0,a=0;const c=new Array(t.length);for(let l=0;l<t.length;l++)c[l]=t[l][0],o+=t[l].length;for(let l=0;l<t.length-1;l++){let e=1e3;const n=t[l],r=t[l+1];if(null===n||null===r)break;const i=n.length,s=r.length;for(let t=0;t<i;t++)for(let i=0;i<s;i++){const s=n[t],o=r[i],a=o>s?1:2,h=Math.abs(s-o)*a;h<e&&(c[l]=s,c[l+1]=o,e=h)}a+=e}const h=Math.min(1e4,...c);return a+=1e3*(s-t.length),{relevance:a+4,count:o,...this._getPreviewTextData(n,r,h,i)}},u.prototype.fixRepeatsBug=function(e,t){return e.slice(t)},u.prototype._searchFullCoincidence=function(e){let{normalizedQuery:t,virginContent:n,normalizedContent:r,pageId:s,queryArray:o,queryArrayLength:c}=e,h=null,u=-1,d=0;const y=this.searchState.exactMatch?p(t):null;let f=r;for(;(u=g({index:u,regExp:y,normalizedQuery:t,normalizedText:f}))>=0;){if(y){const e=u+t.length;f=this.fixRepeatsBug(f,e),u+=d,d+=e}const e=(0===u||(0,a._Q)(r.charAt(u-1)))&&(u+t.length===r.length||(0,a._Q)(r.charAt(u+t.length)))?0:2;if((0,i.Ft)(h)||h.relevance>e){const a=(0,i.Ft)(h)?1:h.count+1,g=(0,i.Ft)(h)?[]:h.positions;g.push({startPos:u,stopPos:u+t.length-1,isFullCoinidence:!0}),h=new l({pageId:s,...this._getPreviewTextData(n,r,u,o),relevance:e,count:a,positions:g,coincidenceData:{virginContent:n,normalizedContent:r,queryArray:o,queryArrayLength:c}})}else h&&(h.count++,h.addPositions([{startPos:u,stopPos:u+t.length-1,isFullCoinidence:!0}]))}return h},u.prototype._searchPartiallyCoincidence=function(e){let{virginContent:t,normalizedContent:n,pageId:r,queryArray:i,queryArrayLength:s}=e;const o=this._buildIndexes(i,s,n);if(null===o||0===o.length)return null;const a=this._getPositions(i,s,n);return new l({pageId:r,...this._getRelevanceForParticiallyCoincidence({indexes:o,virginContent:t,normalizedContent:n,queryArray:i,queryArrayLength:s}),positions:a,coincidenceData:{virginContent:t,normalizedContent:n,queryArray:i,queryArrayLength:s}})},u.prototype._getPositions=function(e,t,n){const r=[];for(let i=0;i<t;i++){const t=e[i];let s=0,o=n.indexOf(t,s);for(;o>=0;)r.push({startPos:o,stopPos:o+t.length-1}),s=o+t.length,o=n.indexOf(t,s)}return r},u.prototype._buildIndexes=function(e,t,n){const r=[];for(let i=0;i<t;i++){const t=[],s=e[i];let o=0,a=n.indexOf(s);for(o=a+this.searchState.searchCharactersLimit;a>=0;)t.push(a),a=n.indexOf(s,o),o=a+this.searchState.searchCharactersLimit;const c=-1===r.toString().indexOf(t.toString());t.length>0&&c&&r.push(t)}return r},u.prototype._getPreviewTextData=function(e,t,n){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[];const i=this.store.getters["search/normalizedQuery"];this.searchState.exactMatch&&(r=[i]);const s=parseInt(this.searchState.maxTextResultLength,10),a=i.length;let c=s;const h=a>s/2?Math.floor(s/4):Math.floor(s/2),l=Math.max(0,n-h);a>s/2&&this.searchState.exactMatch&&(c=a),c+=h;const u=t.substr(l,c),g=(0,o.r)(e,t,this.store.state.pager.singleMode?null:l,this.store.state.pager.singleMode?null:c),p=this._getNormalizedTextIndexes(u,l,r),d=this._getVirginText({indexes:p,globalBegin:l,globalEnd:l+Math.min(e.length,s),virginText:e,normalizedText:t,normalizedToVirginMap:g});return{text:d.results,normalizedToVirginMap:g,previewCount:d.previewCount}},u.prototype._getNormalizedTextIndexes=function(e,t,n){const r=[],i=this.searchState.exactMatch?p(n[0]):null;for(let s=0;s<n.length;s++){const o=n[s];let a=-1,c=0,h=e;for(;(a=g({index:a,regExp:i,normalizedQuery:o,normalizedText:h}))>=0;){if(i){const e=a+o.length;h=this.fixRepeatsBug(h,e),a+=c,c+=e}const e=t+a,n=e+o.length;let s=-1;r.some(((t,r)=>o.length<t.end-t.begin&&t.begin<=e&&t.end>e||o.length>t.end-t.begin&&e<=t.begin&&t.end<n&&(s=r,!0)))?-1!==s&&(r[s].begin=Math.min(r[s].begin,e),r[s].end=Math.max(r[s].end,n)):r.push({begin:e,end:n,emphasize:!0})}}return r.sort(((e,t)=>e.begin-t.begin)),r},u.prototype._getVirginText=function(e){let{indexes:t,globalBegin:n,globalEnd:r,virginText:o,normalizedText:a,normalizedToVirginMap:c}=e;const h=parseInt(this.searchState.maxTextResultLength,10);let l=0,u=0;const g=function(e,t,n,r){let u;const g=c[e],p=c[t];return u=!c||(0,i.o8)(g)||(0,i.o8)(p)?a.substr(e,t-e):o.substr(g,p-g),l+u.length>h&&(u=u.substr(0,h-l)),l+=u.length,n?u="..."+u:r&&(u+="..."),s.Z.decodeExceptions(u)},p=[],d=[];if(!t.length)return d;let y=t[0];for(let i=1;i<t.length;i++){const e=t[i];e.begin<y.end?e.end>y.end&&(y.end=e.end):(p.push(y),y=e)}p.push(y);for(let i=0;i<p.length;i++){const e=p[i],t=i>0?p[i-1].end:n;d.push({text:g(t,e.begin,0===i),emphasize:!1});const s=g(e.begin,e.end);if(d.push({text:s,emphasize:!0}),""!==s&&u++,i===p.length-1||l>=h){const t=g(e.end,r,!1,!0);d.push({text:t,emphasize:!1});break}}return{results:d,previewCount:u}}}}]);